# ВКонтакте Интеграция - Инструкция по установке

## Обзор

Добавлена полная интеграция ВКонтакте с загрузкой CSV файлов статистики сообщества.

### Возможности

- **Загрузка CSV** со статистикой ВК сообщества
- **6 КПИ карточек**: Охват, Показы, Подписчики, ER%, Репосты, Комментарии
- **3 аналитических графика**:
  - График охвата и показов (линейный)
  - График вовлечённости (столбцы + линия ER%)
  - Таблица лучших постов (топ-10 по ER%)
- **Автоматические инсайты**: AI-генерируемые рекомендации на основе метрик
- **История загрузок**: отслеживание всех загруженных CSV файлов

## Установка

### 1. Применить миграцию базы данных

Откройте Supabase SQL Editor и выполните миграцию:

```bash
backend/app/migrations/003_vk_tables.sql
```

Миграция создаст две таблицы:
- `vk_uploads` - метаданные загрузок CSV
- `vk_metrics` - метрики ВКонтакте по датам

### 2. Перезапустить backend

```bash
cd backend
# Если установлены зависимости
python -m uvicorn app.main:app --reload
```

### 3. Перезапустить frontend

```bash
cd frontend
npm run dev
```

## Использование

### 1. Создать канал ВКонтакте

1. Войти в админ-панель: `/admin/login`
2. Перейти в "Каналы" → `/admin/channels`
3. Создать новый канал:
   - Тип: **vk**
   - Название: "ВКонтакте НБ ТГУ" (или любое другое)
   - Is manual: **true** (вручную)

### 2. Загрузить CSV файл

1. Перейти в "ВКонтакте" → `/admin/vk`
2. Нажать "Загрузить CSV"
3. Выбрать канал ВКонтакте
4. Загрузить CSV файл (формат: экспорт из ВК статистики)
5. Дождаться обработки

### 3. Просмотр статистики

После успешной загрузки CSV:
- **КПИ карточки** с динамикой к прошлому периоду
- **Автоматические инсайты** (например: "Охват снизился на 10%, но вовлечённость выросла на 8%")
- **Графики** охвата и вовлечённости
- **Таблица лучших постов** по ER%

## Формат CSV

CSV файл должен быть экспортирован из ВКонтакте со следующей структурой:

```
Раздел;Подраздел;Дата;Время;Вид данных;Сортировка: гранулярность;Сортировка: вид разреза;Параметр легенды;Значение
Сообщество;Общее;01.01.2026;#;Уникальные посетители...;По дням;#;Посетители;26
```

**Поддерживаемые метрики:**
- Посетители → visitors
- Просмотры → views
- Посты → posts
- Истории → stories
- Клипы → clips
- Видео → videos
- Подписались → subscribed
- Отписались → unsubscribed
- Всего подписчиков → total_subscribers
- Перейти на сайт → site_clicks
- Лайки → likes
- Репосты → reposts
- Комментарии → comments

## API Endpoints

### POST /api/vk/upload
Загрузка CSV файла

**Query params:**
- `library_id` (UUID)
- `channel_id` (UUID)

**Body:** multipart/form-data с CSV файлом

**Response:** VkUploadSummary

### GET /api/vk/stats
Получение статистики

**Query params:**
- `library_id` (UUID)
- `channel_id` (UUID, optional)
- `period` (string: week|month|quarter|year)

**Response:** VkStatsResponse

### GET /api/vk/uploads
Список загрузок

**Query params:**
- `library_id` (UUID)
- `channel_id` (UUID, optional)
- `limit` (number, default: 10)

**Response:** VkUpload[]

### DELETE /api/vk/uploads/{upload_id}
Удаление загрузки и связанных метрик

**Auth:** Требуется JWT токен

## Архитектура

**Backend:**
- Models: `VkUpload`, `VkMetric`
- Service: `vk_csv_service.py` (парсинг CSV)
- Router: `vk.py` (API endpoints)
- Insights: `insights_engine.py` (VK правила)

**Frontend:**
- Page: `AdminVkPage.tsx`
- Components:
  - `VkUploadForm` - форма загрузки CSV
  - `VkKpiCards` - 6 КПИ карточек
  - `VkReachChart` - график охвата
  - `VkEngagementChart` - график вовлечённости
  - `VkTopPostsTable` - таблица лучших постов

**База данных:**
- `vk_uploads` - метаданные загрузок
- `vk_metrics` - ВК-специфичные метрики (охват, просмотры, посты, подписчики)
- `engagement_metrics` - универсальные метрики (лайки, репосты, комментарии)

## Troubleshooting

### Ошибка "Invalid CSV format"
- Проверьте, что CSV использует разделитель `;` (точка с запятой)
- Проверьте кодировку: должна быть UTF-8
- Убедитесь, что есть заголовок и минимум одна строка данных

### Ошибка "No VK data found"
- Создайте канал ВКонтакте в разделе "Каналы"
- Загрузите CSV файл через "Загрузить CSV"

### Пустые графики
- Убедитесь, что CSV содержит метрики: Посетители, Просмотры, Лайки, Репосты, Комментарии
- Проверьте, что формат дат корректный: DD.MM.YYYY

## Примеры инсайтов

- "Охват снизился на 10%, но вовлечённость выросла на 8% — аудитория стала меньше, но активнее"
- "Прирост подписчиков +4% — хороший результат при текущем охвате"
- "Высокая вовлечённость 12.5% — контент резонирует с аудиторией"
- "Низкая вовлечённость 1.2% — попробуйте новые форматы (истории, клипы, опросы)"
- "Высокий уровень репостов — контент имеет виральный потенциал"
